!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("arkPlayer",[],t):"object"==typeof exports?exports.arkPlayer=t():(e.Spinitron=e.Spinitron||{},e.Spinitron.arkPlayer=t())}(window,(function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=2)}([function(e,t,n){},function(e,t,n){e.exports=n.p+"../images/loudspeaker.svg"},function(e,t,n){"use strict";n.r(t);n(0),n(1);const r=window.AudioContext||window.webkitAudioContext?new(window.AudioContext||window.webkitAudioContext):null,o=300,a=15;window.arkPlayer=function(e,t){function n(){e.outerHTML="<div>The archive player doesn't work in this browser :(</div>",document.querySelectorAll(".ark-play-button").forEach(e=>e.classList.add("ark-ark-play-button_hide"))}try{if("object"!=typeof r||"function"!=typeof r.resume||"string"!=typeof r.state)return void n()}catch(e){return void n()}const{template:i,data:s={},timeZone:u,enableDebug:l=!1,segmentDuration:c=o,fetchAhead:d=a}=t;let f=e.dataset.arkStart;const p=Object.keys(s).reduce((e,t)=>e.replaceAll(`{${t}}`,s[t]),i);let m=d;const g={dates:[],hours:{}};I("ark player init: ",t,"baseUrl",p);const y=(()=>{let e="?";try{e=(new Date).toLocaleString(["en-US",{timeZone:u}])}catch(e){return[]}return I(e),["en-US",{timeZone:u}]})(),h=e.querySelector(".ark-player__control"),v=e.querySelector(".ark-player__status"),S=e.querySelector(".ark-player__picker");let T,k=null,w=null,b=null,_=null,L=5;function x(t){const n=void 0===t?f:t,r=n.slice(0,11);let o;if(g.dates.some(e=>g.hours[e].some(t=>r===t[1]&&(o=e,!0))),o){const t=e;t.querySelector("[name=date]").value=o,N(t.querySelector("[name=hours]"),o),t.querySelector("[name=hours]").value=r,t.querySelector("[name=minutes]").value=(""+15*Math.floor(parseInt(n.slice(11,13),10)/15)).padStart(2,"0")}}function q(){"not-started"===M()?f&&D(f):function(e){const t=M(),n=void 0===e?"playing"!==t:e;"playing"!==t||n?"paused"===t&&n&&j("running"):j("suspended");A(n)}()}O(),(()=>{const t=new Date,n=t.getTime()-12096e5;let r,o,a=new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours()).getTime();for(;a>n;)a-=36e5,r=new Date(a),o=r.toLocaleDateString(...y).replace(/\d\d(\d\d)$/,"$1"),g.dates.includes(o)||(g.dates.push(o),g.hours[o]=[]),g.hours[o].push([r.toLocaleTimeString(...y).replace(/:00:00 /," "),r.toISOString().substring(0,13).replace(/-/g,"")]);const i=e.querySelector("[name=date]"),s=e.querySelector("[name=hours]"),u=e.querySelector("[name=minutes]");var l;function c(){O(),f=`${s.value}${u.value}00Z`}l=i,g.dates.forEach((e,t)=>{l[t]=new Option(e,e)}),i.addEventListener("change",()=>{N(s,i.value),c()}),s.addEventListener("change",c),N(s,i.value),u.addEventListener("change",c),function(e){["00","15","30","45"].forEach((t,n)=>{e[n]=new Option(":"+t,t)})}(u),x()})();const $=(()=>{let e=!1;const t=document.querySelector(".ark-player__volume-slider"),n=document.querySelector(".ark-player__volume-slash"),o=document.querySelector(".ark-player__mute-button");let a;const i={muteButton:()=>{e=!e,i.either()},slider:()=>{a=parseInt(t.value,10),i.either()},either:()=>{t.value=e?"0":""+a,n.style.cssText=e||0===a?"":"display:none";const o=(e?0:a)/100;b&&b.gainNode&&b.gainNode.gain.setValueAtTime(o,r.currentTime),_&&_.gainNode&&_.gainNode.gain.setValueAtTime(o,r.currentTime)}};return t.addEventListener("change",i.slider),t.addEventListener("input",i.slider),o.addEventListener("click",i.muteButton),i.slider(),i})();function D(e){if(!window.AudioContext&&!window.webkitAudioContext)return;O(!1),x(e);const t=e.match(/^(\d\d\d\d)(\d\d)(\d\d)T(\d\d)(\d\d)(\d\d)Z$/).slice(1).map(e=>parseInt(e,10));w=Date.UTC(t[0],t[1]-1,t[2],t[3],t[4],t[5]);let n=Date.UTC(t[0],t[1]-1,t[2],t[3],0,0);for(;n+1e3*c<=w;)n+=1e3*c;j("running"),P({segmentTime:n,offset:(w-n)/1e3}),T=setInterval(E,1e3)}function O(e){T&&clearInterval(T),_&&_.source&&_.source.stop(),_=null,b&&b.source&&b.source.stop(),b=null,!1!==e&&j("suspended"),w=null,k=null,v.querySelector(".ark-player__date").innerHTML="--/--/--",v.querySelector(".ark-player__time").innerHTML="-:--:-- --",v.classList.toggle("waiting",!0)}function M(){return null===b&&null===_?"not-started":"running"===r.state?"playing":"suspended"===r.state?"paused":(I(`player state?! current: ${b} next: ${_} context: ${r}. resetting`),O(),"not-started")}function j(e){if(r.state!==e){if("suspended"===e)r.suspend();else{if("running"!==e)return;r.resume()}!function t(){r.state!==e&&setTimeout(t,3)}()}}function A(t){const n=void 0===t?"playing"===M():t,r="ark-player_hide";e.classList.toggle(r,!1),h.querySelector(".ark-player__play").classList.toggle(r,n),h.querySelector(".ark-player__pause").classList.toggle(r,!n),S.classList.toggle(r,n),v.classList.toggle(r,!n)}function E(){if("paused"!==M()){if(b&&null===_){const e=b.started+b.source.buffer.duration-b.offset;r.currentTime>e-m&&P({segmentTime:b.segmentTime+1e3*c,offset:0})}if(_&&_.source&&_.started<r.currentTime&&(b=null,b=_,_=null,I("moved next segment to current")),k&&r.currentTime>k){const e=new Date(w+Math.round(1e3*(r.currentTime-k)));v.querySelector(".ark-player__date").innerHTML=e.toLocaleDateString(...y).replace(/(^\d\d?\/\d\d?\/)\d\d(\d\d)/,"$1$2"),v.querySelector(".ark-player__time").innerHTML=e.toLocaleTimeString(...y),v.classList.toggle("waiting",!1)}}}h.addEventListener("click",q),document.addEventListener("click",t=>{const n=t.target.closest("[data-ark-start]");n&&n!==e&&(t.preventDefault(),D(n.dataset.arkStart))}),document.addEventListener("keydown",e=>{e.isComposing||229===e.keyCode||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey||("k"===e.key?q():"m"===e.key&&$.muteButton())});const C=(()=>{const e=[];return{add:({url:t,audio:n})=>{if(e.push({url:t,audio:n}),I("audio cache push "+t),e.length>3){const t=e.shift();I("audio cache discard "+t.url),t.audio=null}I("audio cache content: ",e)},get:t=>{for(let n=0;n<e.length;n+=1)if(e[n].url===t)return I("audio cache hit: "+t),e[n].audio;return I("audio cache miss: "+t),null}}})();function P({segmentTime:e,offset:t}){const n=p.replace("{time}",new Date(e).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}/,""));I(`cuing next segment ${n} offset: ${t}`);const o=C.get(n);if(null!==o)return void H({segmentTime:e,offset:t},o);const a=new XMLHttpRequest,i=(new Date).getTime();a.open("get",n,!0),a.responseType="arraybuffer",a.onerror=()=>{I(`${a.statusText} getting ${n}`)},a.onload=()=>{200===a.status?(L=5,r.decodeAudioData(a.response,r=>{C.add({url:n,audio:r});const o=((new Date).getTime()-i)/1e3;I(`fetch and decode took ${o} s`),o+5>m&&(m=o+5,I(`increase fetch ahead time to ${m} s`)),H({segmentTime:e,offset:t},r)})):L>0?(I("Skip that segment and move on"),L-=1,P({segmentTime:e+1e3*c,offset:0})):(I("Failed to fetch audio after several tries. Resetting player"),O())},_=a,a.send(),A(!0)}function H({segmentTime:e,offset:t},n){const o=r.createGain();o.connect(r.destination);const a=r.createBufferSource();a.buffer=n,a.connect(o);const i=null===b?r.currentTime+.05:Math.max(r.currentTime+.01,b.started+b.source.buffer.duration-b.offset);_={segmentTime:e,source:a,offset:t,started:i,gainNode:o},$.slider(),_.source.start(i,_.offset),null===b&&(k=i),A(),I(`scheduled next segment to start at ${i} offset: ${t}`)}function I(...e){l&&console.log(`${(new Date).toLocaleTimeString()} ac.ct=${r.currentTime}`,...e)}function N(e,t){const n=e,r=n.selectedOptions[0]&&n.selectedOptions[0].innerText;for(;n.options.length>0;)n.remove(0);const o=g.hours[t].length-1;for(let e=0;e<=o;e+=1)n[e]=new Option(g.hours[t][o-e][0],g.hours[t][o-e][1]),r&&n[e].innerText===r&&(n[e].selected=!0)}}}])}));